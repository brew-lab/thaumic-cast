openapi: "3.1.0"
info:
  title: Thaumic Cast Protocol
  version: "1.0.0"
  description: |
    Unified type definitions for Thaumic Cast server, extension, and desktop app.
    This schema is the source of truth for TypeScript and Rust type generation.

paths: {} # No paths defined - types only

components:
  schemas:
    # ============================================================
    # Enums
    # ============================================================

    QualityPreset:
      type: string
      enum:
        - ultra-low
        - low
        - medium
        - high
      description: Audio quality preset for streaming

    AudioCodec:
      type: string
      enum:
        - he-aac
        - aac-lc
        - mp3
      description: Audio codec for encoding

    StreamStatus:
      type: string
      enum:
        - starting
        - active
        - stopped
        - error
      description: Current status of a stream

    SonosMode:
      type: string
      enum:
        - cloud
        - local
      description: Sonos connection mode (cloud API vs local UPnP)

    TransportState:
      type: string
      enum:
        - PLAYING
        - PAUSED_PLAYBACK
        - STOPPED
        - TRANSITIONING
      description: UPnP AVTransport transport states

    GenaService:
      type: string
      enum:
        - AVTransport
        - ZoneGroupTopology
        - GroupRenderingControl
      description: Sonos UPnP services for GENA subscriptions

    ErrorCode:
      type: string
      enum:
        # Network errors
        - NETWORK_TIMEOUT
        - NETWORK_UNREACHABLE
        - CONNECTION_REFUSED
        # Sonos errors
        - SPEAKER_NOT_FOUND
        - SPEAKER_UNREACHABLE
        - DISCOVERY_FAILED
        - PLAYBACK_FAILED
        - INVALID_STREAM_URL
        # Validation errors
        - INVALID_IP_ADDRESS
        - INVALID_URL
        - INVALID_REQUEST
        # Auth errors
        - UNAUTHORIZED
        - SESSION_EXPIRED
        # Generic
        - UNKNOWN_ERROR
      description: Structured error codes for error handling

    # ============================================================
    # Stream Metadata
    # ============================================================

    StreamMetadata:
      type: object
      description: Stream metadata for Sonos display (ICY metadata)
      properties:
        title:
          type: string
          description: Song title or tab title
        artist:
          type: string
          description: Artist name
        album:
          type: string
          description: Album name
        artwork:
          type: string
          description: Album art URL

    # ============================================================
    # Speaker & Group Types
    # ============================================================

    Speaker:
      type: object
      description: Minimal speaker info from SSDP discovery
      required:
        - uuid
        - ip
      properties:
        uuid:
          type: string
          description: Unique identifier from SSDP
        ip:
          type: string
          description: Local IP address

    LocalSpeaker:
      type: object
      description: Full speaker info including zone name and model
      required:
        - uuid
        - ip
        - zoneName
        - model
      properties:
        uuid:
          type: string
          description: Unique identifier from zone topology
        ip:
          type: string
          description: Local IP address
        zoneName:
          type: string
          description: User-configured room name
        model:
          type: string
          description: Sonos device model (e.g., "Sonos One")

    LocalGroup:
      type: object
      description: Sonos zone group with coordinator and members
      required:
        - id
        - name
        - coordinatorUuid
        - coordinatorIp
        - members
      properties:
        id:
          type: string
          description: Zone group identifier
        name:
          type: string
          description: Coordinator's zone name
        coordinatorUuid:
          type: string
          description: UUID of the group coordinator
        coordinatorIp:
          type: string
          description: IP address of the group coordinator
        members:
          type: array
          description: Speakers in this group
          items:
            $ref: "#/components/schemas/LocalSpeaker"

    SonosGroup:
      type: object
      description: Sonos group from cloud API
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: Cloud API group identifier
        name:
          type: string
          description: Group display name

    GroupStatus:
      type: object
      description: Runtime status of a Sonos group from GENA events
      required:
        - coordinatorIp
        - transportState
        - volume
        - isMuted
      properties:
        coordinatorIp:
          type: string
          description: IP address of the group coordinator
        transportState:
          $ref: "#/components/schemas/TransportState"
        currentUri:
          type: string
          nullable: true
          description: Current track/source URI
        isPlayingOurStream:
          type: boolean
          nullable: true
          description: True if playing our stream, false if playing other source, null if unknown
        volume:
          type: integer
          minimum: 0
          maximum: 100
          description: Group volume level (0-100)
        isMuted:
          type: boolean
          description: Whether the group is muted

    SonosStateSnapshot:
      type: object
      description: Complete Sonos state snapshot emitted on any change
      required:
        - groups
        - group_statuses
        - discovered_devices
        - gena_subscriptions
        - is_discovering
      properties:
        groups:
          type: array
          description: Zone groups with their members
          items:
            $ref: "#/components/schemas/LocalGroup"
        group_statuses:
          type: array
          description: Runtime status for each group coordinator
          items:
            $ref: "#/components/schemas/GroupStatus"
        discovered_devices:
          type: integer
          format: uint64
          description: Number of Sonos devices from last discovery
        gena_subscriptions:
          type: integer
          format: uint64
          description: Number of active GENA subscriptions
        last_discovery_at:
          type: integer
          format: uint64
          nullable: true
          description: Unix timestamp of last successful speaker discovery
        is_discovering:
          type: boolean
          description: True while SSDP discovery is running

    # ============================================================
    # API Request/Response Types
    # ============================================================

    CreateStreamRequest:
      type: object
      description: Request to create a new audio stream
      required:
        - groupId
        - quality
      properties:
        groupId:
          type: string
        quality:
          $ref: "#/components/schemas/QualityPreset"
        metadata:
          $ref: "#/components/schemas/StreamMetadata"
        codec:
          $ref: "#/components/schemas/AudioCodec"

    CreateStreamResponse:
      type: object
      description: Response after creating a stream
      required:
        - streamId
        - ingestUrl
        - playbackUrl
      properties:
        streamId:
          type: string
        ingestUrl:
          type: string
          description: WebSocket URL for audio ingest
        playbackUrl:
          type: string
          description: HTTP URL for stream playback
        warning:
          type: string
          description: Non-fatal issues (e.g., GENA subscription failed)

    MeResponse:
      type: object
      description: GET /api/me response
      required:
        - user
        - sonosLinked
      properties:
        user:
          oneOf:
            - type: "null"
            - type: object
              required:
                - id
                - email
              properties:
                id:
                  type: string
                email:
                  type: string
                name:
                  type: string
        sonosLinked:
          type: boolean

    SonosStatusResponse:
      type: object
      description: GET /api/sonos/status response
      required:
        - linked
      properties:
        linked:
          type: boolean
        householdId:
          type: string

    SonosGroupsResponse:
      type: object
      description: GET /api/sonos/groups response (cloud API)
      required:
        - householdId
        - groups
      properties:
        householdId:
          type: string
        groups:
          type: array
          items:
            $ref: "#/components/schemas/SonosGroup"

    LocalDiscoveryResponse:
      type: object
      description: GET /api/local/discover response
      required:
        - speakers
      properties:
        speakers:
          type: array
          items:
            $ref: "#/components/schemas/Speaker"

    LocalGroupsResponse:
      type: object
      description: GET /api/local/groups response
      required:
        - groups
      properties:
        groups:
          type: array
          items:
            $ref: "#/components/schemas/LocalGroup"

    ApiError:
      type: object
      description: Basic API error response
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string

    ApiErrorResponse:
      type: object
      description: Enhanced API error response with structured code
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        code:
          $ref: "#/components/schemas/ErrorCode"
        details:
          type: object
          additionalProperties: true

    # ============================================================
    # GENA Subscription
    # ============================================================

    GenaSubscription:
      type: object
      description: GENA subscription info stored per speaker/service
      required:
        - sid
        - speakerIp
        - service
        - expiresAt
        - callbackPath
      properties:
        sid:
          type: string
          description: Subscription ID from SUBSCRIBE response
        speakerIp:
          type: string
        service:
          $ref: "#/components/schemas/GenaService"
        expiresAt:
          type: integer
          format: int64
          description: Unix timestamp when subscription expires
        callbackPath:
          type: string

    # ============================================================
    # Sonos Events (Discriminated Union)
    # ============================================================

    TransportStateEvent:
      type: object
      description: Transport state change event from Sonos speaker
      required:
        - type
        - state
        - speakerIp
        - timestamp
      properties:
        type:
          type: string
          const: transportState
        state:
          $ref: "#/components/schemas/TransportState"
        speakerIp:
          type: string
        timestamp:
          type: integer
          format: int64

    ZoneChangeEvent:
      type: object
      description: Zone group topology change event
      required:
        - type
        - timestamp
      properties:
        type:
          type: string
          const: zoneChange
        timestamp:
          type: integer
          format: int64

    SourceChangedEvent:
      type: object
      description: Source changed event - fired when Sonos switches audio source
      required:
        - type
        - currentUri
        - speakerIp
        - timestamp
      properties:
        type:
          type: string
          const: sourceChanged
        currentUri:
          type: string
        expectedUri:
          type:
            - string
            - "null"
        speakerIp:
          type: string
        timestamp:
          type: integer
          format: int64

    GroupVolumeChangeEvent:
      type: object
      description: Group volume change event from GroupRenderingControl
      required:
        - type
        - volume
        - speakerIp
        - timestamp
      properties:
        type:
          type: string
          const: groupVolume
        volume:
          type: integer
          minimum: 0
          maximum: 100
        speakerIp:
          type: string
        timestamp:
          type: integer
          format: int64

    GroupMuteChangeEvent:
      type: object
      description: Group mute state change event from GroupRenderingControl
      required:
        - type
        - mute
        - speakerIp
        - timestamp
      properties:
        type:
          type: string
          const: groupMute
        mute:
          type: boolean
        speakerIp:
          type: string
        timestamp:
          type: integer
          format: int64

    ZoneGroupsUpdatedEvent:
      type: object
      description: Zone groups have been updated (from ZoneGroupTopology GENA event)
      required:
        - type
        - groups
        - timestamp
      properties:
        type:
          type: string
          const: zoneGroupsUpdated
        groups:
          type: array
          items:
            $ref: "#/components/schemas/LocalGroup"
        timestamp:
          type: integer
          format: int64

    SubscriptionLostEvent:
      type: object
      description: GENA subscription was lost and needs recovery
      required:
        - type
        - speakerIp
        - timestamp
      properties:
        type:
          type: string
          const: subscriptionLost
        speakerIp:
          type: string
        timestamp:
          type: integer
          format: int64

    SonosEvent:
      description: Union type for all Sonos events sent via WebSocket
      oneOf:
        - $ref: "#/components/schemas/TransportStateEvent"
        - $ref: "#/components/schemas/ZoneChangeEvent"
        - $ref: "#/components/schemas/SourceChangedEvent"
        - $ref: "#/components/schemas/GroupVolumeChangeEvent"
        - $ref: "#/components/schemas/GroupMuteChangeEvent"
        - $ref: "#/components/schemas/ZoneGroupsUpdatedEvent"
        - $ref: "#/components/schemas/SubscriptionLostEvent"
      discriminator:
        propertyName: type
        mapping:
          transportState: "#/components/schemas/TransportStateEvent"
          zoneChange: "#/components/schemas/ZoneChangeEvent"
          sourceChanged: "#/components/schemas/SourceChangedEvent"
          groupVolume: "#/components/schemas/GroupVolumeChangeEvent"
          groupMute: "#/components/schemas/GroupMuteChangeEvent"
          zoneGroupsUpdated: "#/components/schemas/ZoneGroupsUpdatedEvent"
          subscriptionLost: "#/components/schemas/SubscriptionLostEvent"

    # ============================================================
    # Tauri Command Types (snake_case for Rust IPC)
    # ============================================================

    StatusResponse:
      type: object
      description: Tauri get_status command response
      required:
        - server_running
        - port
        - active_streams
        - discovered_devices
        - gena_subscriptions
        - connected_clients
      properties:
        server_running:
          type: boolean
        port:
          type: integer
          format: uint16
          description: HTTP server port
        gena_port:
          type: integer
          format: uint16
          nullable: true
          description: GENA listener port (null if not started)
        local_ip:
          type: string
          nullable: true
          description: Local network IP address
        active_streams:
          type: integer
          format: uint64
        discovered_devices:
          type: integer
          format: uint64
          description: Number of Sonos devices from last discovery
        gena_subscriptions:
          type: integer
          format: uint64
          description: Number of active GENA subscriptions
        connected_clients:
          type: integer
          format: uint64
          description: Number of connected WebSocket clients (extensions)
        startup_errors:
          type: array
          items:
            type: string
          description: Non-fatal errors encountered during startup
        last_discovery_at:
          type: integer
          format: uint64
          nullable: true
          description: Unix timestamp of last successful speaker discovery

    ConfigResponse:
      type: object
      description: Tauri get_config command response
      required:
        - port
      properties:
        port:
          type: integer
          format: uint16

    # ============================================================
    # WebSocket Command/Response Protocol
    # ============================================================

    WsAction:
      type: string
      enum:
        - getGroups
        - getVolume
        - setVolume
        - getMute
        - setMute
        - play
        - stop
        - createStream
        - stopStream
        - updateMetadata
        - discover
      description: WebSocket command actions

    WsCommand:
      type: object
      description: WebSocket command from client to server
      required:
        - id
        - action
      properties:
        id:
          type: string
          description: Unique request ID for response correlation
        action:
          $ref: "#/components/schemas/WsAction"
        payload:
          type: object
          additionalProperties: true
          description: Action-specific payload data

    WsResponse:
      type: object
      description: WebSocket response from server to client
      required:
        - id
        - success
      properties:
        id:
          type: string
          description: Request ID this response correlates to
        success:
          type: boolean
        data:
          type: object
          additionalProperties: true
          description: Response payload on success
        error:
          type: string
          description: Error message on failure

    WsConnectedEvent:
      type: object
      description: Event sent on WebSocket connection with initial state
      required:
        - type
        - state
      properties:
        type:
          type: string
          const: connected
        state:
          $ref: "#/components/schemas/SonosStateSnapshot"
